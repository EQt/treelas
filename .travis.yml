language: cpp

git:
  submodules: false

matrix:
  include:
    - os: linux
      env: CXX=g++-7 CC=gcc-7
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-7
    - os: osx
      env: CXX=clang++ CC=clang

## https://docs.travis-ci.com/user/caching/
# cache:
#   directories:
#     - $TRAVIS_BUILD_DIR/miniconda3

# before_cache:
#   - rm -fr $TRAVIS_BUILD_DIR/miniconda3/envs

before_install:
  - uname -a
  - echo $CXX
  - $CXX --version
  - echo $TRAVIS_OS_NAME
  - pwd
  - if [[ ! -d $PWD/miniconda3 ]]; then
      if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
        wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
      elif [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
         wget https://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O miniconda.sh;
      fi;
      bash miniconda.sh -b -p $PWD/miniconda3;
    fi
  - export PATH=$PWD/miniconda3/bin:$PATH;
  - which conda
  - conda install -y pytest h5py numba
  - which python
  - pip install pybind11
  - python -m pybind11 --include

script:
  - mkdir -p build
  - cd build
  - cmake .. -DCMAKE_CXX_COMPILER=$CXX -DCMAKE_C_COMPILER=$CC
  - make tests
  - ./tests
  - cd ../python
  - pwd
  - python setup.py install
  - py.test

after_script:
  - pip uninstall -y treelas
